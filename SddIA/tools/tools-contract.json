{
  "contract_version": "1.1.0",
  "scope": "paths.toolsPath (Cúmulo)",
  "description": "Contrato que toda herramienta (tool) en paths.toolsPath (Cúmulo) debe cumplir: salida JSON adecuada al fin de la herramienta y feedback estructurado.",
  "default_implementation": {
    "language": "rust",
    "rationale": "Rendimiento, seguridad de memoria, portabilidad y distribución como binario. Las implementaciones por defecto de tools y de scripts de skills han de ser en Rust.",
    "delivery": [
      "Cada herramienta reside en una capsula paths.toolsPath (Cúmulo) /<tool-id>/ con manifest.json. Los ejecutables se construyen en paths.toolsRustPath (Cúmulo) y se copian a paths.toolsPath (Cúmulo) /<tool-id>/bin/.",
      "Launcher .bat/.ps1 en la capsula invoca el .exe en bin/ si existe; si no, fallback a PowerShell. Wrappers .bat en paths.toolsPath (Cúmulo) / delegan a la capsula.",
      "Config (.json), documentacion (.md) y manifest.json obligatorios en la capsula. Rutas canonicas: Cúmulo paths.toolCapsules."
    ]
  },
  "output": {
    "description": "Toda herramienta debe producir al finalizar un resultado en formato JSON, adecuado a su propósito.",
    "required_fields": {
      "toolId": "Identificador de la herramienta (kebab-case, ej. prepare-full-env).",
      "exitCode": "Código de salida numérico (0 = éxito, distinto de 0 = fallo).",
      "success": "Booleano: true si la ejecución fue correcta.",
      "timestamp": "ISO 8601 de finalización (UTC recomendado).",
      "message": "Mensaje breve de resumen (humano y máquina).",
      "feedback": "Array de entradas de feedback ordenadas cronológicamente."
    },
    "optional_fields": {
      "data": "Objeto libre con datos específicos del fin de la herramienta (servicios levantados, URLs, errores por fase, etc.).",
      "duration_ms": "Duración total de la ejecución en milisegundos."
    },
    "output_modes": [
      "Escribir el JSON en un fichero si se indica -OutputPath (o equivalente).",
      "Emitir el JSON por stdout si se indica -OutputJson o variable de entorno TOOLS_OUTPUT_JSON=1.",
      "En cualquier caso, el resultado interno debe poder serializarse según este esquema."
    ]
  },
  "feedback": {
    "description": "Las herramientas deben mantener un feedback adecuado: trazabilidad de fases, niveles y mensajes.",
    "rules": [
      "Cada fase o paso significativo debe generar al menos una entrada en feedback.",
      "En caso de error, debe existir una entrada con level 'error' que describa el fallo.",
      "Las advertencias (recursos no disponibles, timeouts parciales) deben registrarse con level 'warning'."
    ],
    "entry_schema": {
      "phase": "Identificador de la fase o paso (ej. docker, mysql, api, clients).",
      "level": "info | warning | error.",
      "message": "Texto breve y legible del evento.",
      "timestamp": "ISO 8601 del momento del evento."
    },
    "optional_per_entry": {
      "detail": "Texto adicional o código de error.",
      "duration_ms": "Duración del paso en ms."
    }
  },
  "required_artefacts_per_tool": [
    { "ext": ".rs", "path": "paths.toolsRustPath (Cúmulo)/src/bin", "purpose": "Implementación por defecto en Rust." },
    { "ext": "binary", "path": "paths.toolsPath (Cúmulo) /<tool-id>/bin/<tool_bin>.exe", "purpose": "Ejecutable Rust en la capsula (copiado desde tools-rs/install.ps1)." },
    { "ext": ".ps1", "purpose": "Fallback cuando no exista binario Rust." },
    { "ext": ".bat", "purpose": "Launcher en capsula: binario en bin/ si existe, si no .ps1. Opcional: wrapper en paths.toolsPath (Cúmulo) / que delegue a la capsula." },
    { "ext": ".json", "naming": "manifest", "purpose": "Manifest de la capsula: toolId, components, contract_ref (obligatorio en cada capsula)." },
    { "ext": ".json", "naming": "<tool-id>-config", "purpose": "Configuración machine-readable." },
    { "ext": ".md", "naming": "<tool-id>.md", "purpose": "Documentación. Idioma: es-ES." }
  ],
  "security_model": {
    "required_token": "Karma2Token",
    "token_ref": "SddIA/tokens/karma2-token/spec.json",
    "description": "Toda tool debe ejecutarse bajo el contexto de un Karma2Token válido."
  },
  "constraints": [
    "Cumplimiento obligatorio de Karma2Token para trazabilidad y seguridad.",
    "toolId en kebab-case.",
    "El JSON de salida debe ser válido y codificado en UTF-8.",
    "No escribir feedback sensible (contraseñas, tokens) en message ni en data.",
    "exitCode 0 únicamente cuando success es true; en caso de fallo, success false y exitCode != 0."
  ],
  "consumers": ["paths.actionsPath", "SddIA/agents/*.json", "paths.toolsPath", "CI/CD"]
}
